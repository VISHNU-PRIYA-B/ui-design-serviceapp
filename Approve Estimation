// @ts-nocheck
import React, { useEffect, useState, useContext, useLayoutEffect } from "react";
import {View,Text,StyleSheet,TouchableOpacity,Alert,ActivityIndicator,Linking,ScrollView,} from "react-native";
import { LinearGradient } from "expo-linear-gradient";
import { graphqlRequest, setAuthToken, BACKEND_BASE_URL } from "../services/api";
import { UserContext } from "../components/ui/UserContext";
import { useLogout } from "../hooks/Logout";
import { useRoute, useNavigation } from "@react-navigation/native";
import AsyncStorage from "@react-native-async-storage/async-storage";

/* COLORS */
const COLORS = {
  gradientStart: "#8B7FE8",
  gradientEnd: "#A89DEF",
  white: "#FFFFFF",
  textDark: "#1E1E1E",
  textMuted: "#8A8A8A",
  cardBg: "#FFFFFF",
  cardBorder: "#ECECF3",
  sectionBg: "#F7F8FC",
  success: "#27AE60",
  danger: "#E74C3C",
  link: "#3498DB",

  pending: "#FFF3CD",
  pendingText: "#856404",
  ready: "#E5D9F2",
  readyText: "#6B4B9E",
  rejected: "#F8D7DA",
  rejectedText: "#721C24",
};

export default function ApproveEstimation() {
  const route = useRoute<any>();
  const { requestId } = route.params;

  const { token: contextToken } = useContext(UserContext);
  const navigation = useNavigation();
  const logout = useLogout();

  const [estimation, setEstimation] = useState<any>(null);
  const [loading, setLoading] = useState(true);

  /* HEADER */
  useLayoutEffect(() => {
    navigation.setOptions({
      headerRight: () => (
        <TouchableOpacity onPress={logout} style={{ marginRight: 15 }}>
          <Text style={{ color: "#E74C3C", fontWeight: "bold" }}>Logout</Text>
        </TouchableOpacity>
      ),
    });
  }, []);

  /* FETCH SINGLE ESTIMATION */
  const fetchMyEstimation = async () => {
  const token = contextToken || (await AsyncStorage.getItem("token"));

  if (!token || !requestId) {
    console.log("Missing token or estimationId");
    setLoading(false);
    return;
  }

  setAuthToken(token);
  setLoading(true);

  const query = `
    query MyEstimation($requestId: String!) {
  myEstimation(requestId: $requestId) {
    id
    total
    approved
    invoice {
      invoiceNumber
      pdfUrl
    }
    repairRequest {
      requestId
      itemName
      problemDescription
      status
      createdAt
    }
    items {
      id
      description
      quantity
      unitPrice
      amount
    }
  }
}

  `;

  try {
    const res = await graphqlRequest(query, { requestId });
    console.log("Fetched estimation:", res);
    setEstimation(res?.myEstimation || []);
  } catch (e) {
    Alert.alert("No estimation has been added");
  } finally {
    setLoading(false);
  }
};


  useEffect(() => {
    fetchMyEstimation();
  }, [requestId]);

  /* APPROVE / REJECT */
const updateApproval = async (approved) => {
  try {
    const mutation = `
      mutation ApproveEstimation($requestId: String!, $approved: Boolean!) {
        approveEstimation(requestId: $requestId, approved: $approved) {
          success
          estimation {
            id
          }
        }
      }
    `;

    await graphqlRequest(mutation, {
      requestId,
      approved,
    });

    Alert.alert(
      "Success",
      approved ? "Estimation approved" : "Estimation rejected"
    );

    fetchMyEstimation();
  } catch (e) {
    console.error("Approve error", e);
    Alert.alert("Error", "Action failed");
  }
};


  const getStatusStyle = (status: string) => {
  
    if (status === "PENDING")
      return { bg: COLORS.pending, text: COLORS.pendingText };
    if (status === "READY_TO_DELIVER")
      return { bg: COLORS.ready, text: COLORS.readyText };
    if (status === "REJECTED")
      return { bg: COLORS.rejected, text: COLORS.rejectedText };
    return { bg: "#EEE", text: "#333" };
  };

  /* LOADING */
  if (loading) {
    return (
      <LinearGradient
        colors={[COLORS.gradientStart, COLORS.gradientEnd]}
        style={styles.center}
      >
        <ActivityIndicator size="large" color="#FFF" />
        <Text style={{ color: "#FFF", marginTop: 10 }}>Loading estimationâ€¦</Text>
      </LinearGradient>
    );
  }

  if (!estimation) {
    return (
      <View style={styles.center}>
        <Text>No estimation found</Text>
      </View>
    );
  }

  const statusStyle = getStatusStyle(estimation.repairRequest.status);

  return (
    <LinearGradient
      colors={[COLORS.gradientStart, COLORS.gradientEnd]}
      style={styles.container}
    >
      <ScrollView contentContainerStyle={styles.content}>
        <Text style={styles.headerTitle}>Approve Estimation</Text>

        <View style={styles.card}>
          {/* HEADER */}
          <View style={styles.cardHeader}>
            <Text style={styles.itemName}>
              {estimation.repairRequest.itemName}
            </Text>

            <View style={[styles.statusBadge, { backgroundColor: statusStyle.bg }]}>
              <Text style={[styles.statusText, { color: statusStyle.text }]}>
                {estimation.repairRequest.status.replaceAll("_", " ")}
              </Text>
            </View>
          </View>

          {/* PROBLEM */}
          <View style={styles.problemBox}>
            <Text style={styles.problemLabel}>Problem</Text>
            <Text style={styles.problemText}>
              {estimation.repairRequest.problemDescription}
            </Text>
          </View>

          {/* ITEMS */}
          {estimation.items.map((i: any) => (
            <View key={i.id} style={styles.itemRow}>
              <View>
                <Text style={styles.itemDesc}>{i.description}</Text>
                <Text style={styles.itemQty}>
                  {i.quantity} Ã— â‚¹{i.unitPrice}
                </Text>
              </View>
              <Text style={styles.itemAmt}>â‚¹{i.amount}</Text>
            </View>
          ))}

          {/* TOTAL */}
          <View style={styles.totalRow}>
            <Text style={styles.totalLabel}>Total</Text>
            <Text style={styles.totalValue}>â‚¹{estimation.total}</Text>
          </View>

          {/* INVOICE */}
          {estimation.invoice?.pdfUrl && (
            <TouchableOpacity
              style={styles.invoiceBtn}
              onPress={() =>
                Linking.openURL(`${BACKEND_BASE_URL}${estimation.invoice.pdfUrl}`)
              }
            >
              <Text style={styles.invoiceText}>ðŸ“„ View Invoice</Text>
            </TouchableOpacity>
          )}

          {/* ACTIONS */}
          {estimation.repairRequest.status === "PENDING" && (
            <View style={styles.actionRow}>
              <TouchableOpacity
                style={styles.acceptBtn}
                onPress={() => updateApproval(true)}
              >
                <Text style={styles.actionText}>âœ“ Accept</Text>
              </TouchableOpacity>

              <TouchableOpacity
                style={styles.rejectBtn}
                onPress={() => updateApproval(false)}
              >
                <Text style={styles.actionText}>âœ• Reject</Text>
              </TouchableOpacity>
            </View>
          )}
          {/* update status */}
          {estimation.repairRequest.status !=="REJECTED" &&(
            <TouchableOpacity style={styles.updateBtn}
            onPress={()=>{
              navigation.navigate("UpdateStatus",{
                requestId: requestId,
              });
            }}>
              <Text style={styles.updateBtnText}>Update Status</Text>
            </TouchableOpacity>
          )}
        </View>
      </ScrollView>
    </LinearGradient>
  );
}

/* STYLES */
const styles = StyleSheet.create({
  container: { flex: 1 },
  content: { padding: 16 },
  center: { flex: 1, justifyContent: "center", alignItems: "center" },

  headerTitle: {
    fontSize: 26,
    fontWeight: "700",
    color: "#FFF",
    marginBottom: 20,
  },

  card: {
    backgroundColor: COLORS.cardBg,
    borderRadius: 20,
    padding: 18,
  },

  cardHeader: {
    flexDirection: "row",
    justifyContent: "space-between",
    marginBottom: 12,
  },

  itemName: {
    fontSize: 18,
    fontWeight: "700",
    color: COLORS.textDark,
  },

  statusBadge: {
    paddingHorizontal: 12,
    paddingVertical: 6,
    borderRadius: 16,
  },

  statusText: {
    fontSize: 11,
    fontWeight: "700",
  },

  problemBox: {
    backgroundColor: COLORS.sectionBg,
    padding: 14,
    borderRadius: 12,
    marginBottom: 12,
  },

  problemLabel: {
    fontSize: 11,
    color: COLORS.textMuted,
    marginBottom: 4,
  },

  problemText: {
    fontSize: 14,
    color: COLORS.textDark,
  },

  itemRow: {
    flexDirection: "row",
    justifyContent: "space-between",
    marginBottom: 8,
  },

  itemDesc: { fontSize: 14, fontWeight: "600" },
  itemQty: { fontSize: 12, color: COLORS.textMuted },
  itemAmt: { fontWeight: "700" },

  totalRow: {
    flexDirection: "row",
    justifyContent: "space-between",
    marginTop: 12,
    paddingTop: 12,
    borderTopWidth: 1,
    borderColor: COLORS.cardBorder,
  },

  totalLabel: { fontWeight: "600" },
  totalValue: { fontSize: 20, fontWeight: "700" },

  invoiceBtn: {
    marginTop: 12,
    padding: 12,
    alignItems: "center",
    backgroundColor: COLORS.sectionBg,
    borderRadius: 12,
  },

  invoiceText: { color: COLORS.link, fontWeight: "600" },

  actionRow: {
    flexDirection: "row",
    gap: 10,
    marginTop: 16,
  },

  acceptBtn: {
    flex: 1,
    backgroundColor: COLORS.success,
    padding: 14,
    borderRadius: 14,
    alignItems: "center",
  },

  rejectBtn: {
    flex: 1,
    backgroundColor: COLORS.danger,
    padding: 14,
    borderRadius: 14,
    alignItems: "center",
  },

  actionText: {
    color: "#FFF",
    fontWeight: "700",
  },
    updateBtn: {
    backgroundColor: "#3ff7ba",
    paddingVertical: 16,
    borderRadius: 16,
    marginTop: 24,
  },
  updateBtnText: {
    textAlign: "center",
    fontSize: 17,
    color: "#111827",
  },
});
