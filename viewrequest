// @ts-nocheck
import React, { useState, useContext, useCallback,useLayoutEffect } from "react";
import {View,Text,ScrollView,TouchableOpacity,ActivityIndicator,StyleSheet,} from "react-native";
import { useNavigation, useFocusEffect } from "@react-navigation/native";
import { graphqlRequest } from "../services/api";
import { UserContext } from "../components/ui/UserContext";
import { LinearGradient } from 'expo-linear-gradient';
import { Ionicons } from "@expo/vector-icons";


const COLORS = {

  gradientStart: "#8B7FE8",
  gradientEnd: "#A89DEF",
  white: "#FFFFFF",
  primary: "#7B6EF6",
  primaryDark: "#6B5EE6",
  accent: "#C7F36B",
  accentDark: "#B7E35B",
  textDark: "#1E1E1E",
  textMuted: "#8A8A8A",
  textLight: "#FFFFFF",
  cardBg: "#FFFFFF",
  cardBorder: "#ECECF3",
  sectionBg: "#F7F8FC",
  
  // Status colors - more vibrant
  pending: "#FFF3CD",
  pendingText: "#856404",
  started: "#DFF5E1",
  startedText: "#155724",
  repairing: "#CCE4FF",
  repairingText: "#004085",
  testing: "#CFF4FC",
  testingText: "#0C5460",
  ready: "#E5D9F2",
  readyText: "#6B4B9E",
  rejected: "#F8D7DA",
  rejectedText: "#721C24",
  WaitingForApproval:"#FFF3CD",
  WaitingForApprovalText:"#856404",
};

/* GRAPHQL */
const ALL_REQUESTS_QUERY = `
  query {
    allRequests {
      requestId
      itemName
      problemDescription
      contactInfo
      createdAt
      estimations{
      status
      approved
      createdAt
      }
    }
  }
`;

const MY_REQUESTS_QUERY = `
  query {
    myRequests {
      itemName
      problemDescription
      contactInfo
      createdAt
      estimations{
      status
      approved
      createdAt
      }
    }
  }
`;

export default function ViewRequest() {
  const { user, loading: authLoading } = useContext(UserContext);
  const navigation = useNavigation();

  const [requests, setRequests] = useState([]);
  const [loading, setLoading] = useState(true);

  const loadRequests = async () => {
    try {
      if (!user) return;

      setLoading(true);
      const query = user.admin ? ALL_REQUESTS_QUERY : MY_REQUESTS_QUERY;
      const res = await graphqlRequest(query);

      const data = user.admin
        ? res?.allRequests || res?.data?.allRequests
        : res?.myRequests || res?.data?.myRequests;

      setRequests((data || []).filter(Boolean));
    } catch (err) {
      console.log("Error loading requests:", err);
    } finally {
      setLoading(false);
    }
  };

    useLayoutEffect(() => {
      navigation.setOptions({
        headerShown: false,
      });
    }, [navigation]);

  useFocusEffect(
    useCallback(() => {
      if (!authLoading && user) {
        loadRequests();
      }
    }, [authLoading, user])
  );

  if (authLoading || loading) {
    return (
      <LinearGradient
        colors={[COLORS.gradientStart, COLORS.gradientEnd]}
        style={styles.loadingContainer}
      >
        <ActivityIndicator size="large" color={COLORS.white} />
        <Text style={styles.loadingText}>Loading requests...</Text>
      </LinearGradient>
    );
  }

  if (!user) {
    return (
      <LinearGradient
        colors={[COLORS.gradientStart, COLORS.gradientEnd]}
        style={styles.errorContainer}
      >
        <Text style={styles.errorText}>‚ö†Ô∏è</Text>
        <Text style={styles.errorMessage}>User not loaded</Text>
      </LinearGradient>
    );
  }

  /* GROUP BY DATE */
  const groupedData = requests.reduce((acc, item) => {
    const date = new Date(item.createdAt).toLocaleDateString("en-IN", {
      day: "2-digit",
      month: "short",
      year: "numeric",
    });
    if (!acc[date]) acc[date] = [];
    acc[date].push(item);
    return acc;
  }, {});

  const getStatusColors = (status) => {
    switch (status) {
      case "PENDING":
        return { bg: COLORS.pending, text: COLORS.pendingText };
      case "STARTED":
        return { bg: COLORS.started, text: COLORS.startedText };
      case "REPAIRING":
        return { bg: COLORS.repairing, text: COLORS.repairingText };
      case "TESTING":
        return { bg: COLORS.testing, text: COLORS.testingText };
      case "READY_TO_DELIVER":
        return { bg: COLORS.ready, text: COLORS.readyText };
      case "REJECTED":
        return { bg: COLORS.rejected, text: COLORS.rejectedText };
      case "WAITING_FOR_APPROVAL":
        return {bg: COLORS.WaitingForApproval, text: COLORS.WaitingForApprovalText};
      default:
        return { bg: "#EEE", text: "#333" };
    }
  };

  const formatStatus = (status) => {
    if(!status) return "PENDING";
    return status.replaceAll(/_/g, " ");
  };

  // Check if there are no requests
  if (Object.keys(groupedData).length === 0) {
    return (
      <LinearGradient
        colors={[COLORS.gradientStart, COLORS.gradientEnd]}
        style={styles.emptyContainer}
      >
        <Text style={styles.emptyIcon}>üìã</Text>
        <Text style={styles.emptyTitle}>No Requests Yet</Text>
        <Text style={styles.emptyMessage}>
          {user.admin
            ? "No repair requests have been submitted"
            : "You haven't submitted any repair requests"}
        </Text>
      </LinearGradient>
    );
  }
  /* UI */
  return (
    <LinearGradient
      colors={[COLORS.gradientStart, COLORS.gradientEnd]}
      style={styles.container}
    >
      <ScrollView 
        style={styles.scrollView}
        contentContainerStyle={styles.contentContainer}
        showsVerticalScrollIndicator={false}
      >
                      <View style={styles.headerTop}>
                  <TouchableOpacity 
                    style={styles.backButton}
                    onPress={() => navigation.goBack()}
                  >
                    <Ionicons name="arrow-back" size={24} color="#fff" />
                  </TouchableOpacity>
                        </View>
        {/* Header */}
        <View style={styles.header}>
          <Text style={styles.headerTitle}>
            {user.admin ? "Requests" : "My Requests"}
          </Text>
          <Text style={styles.headerSubtitle}>
            {requests.length} {requests.length === 1 ? "request" : "requests"} total
          </Text>
        </View>

        {/* Grouped Cards */}
        {Object.keys(groupedData).map((date) => (
          <View key={date} style={styles.dateSection}>
            <View style={styles.dateHeaderContainer}>
              <View style={styles.dateDivider} />
              <Text style={styles.dateHeader}>{date}</Text>
              <View style={styles.dateDivider} />
            </View>

            {groupedData[date].map((req) => {
              const latestEstimation =
  req.estimations
    ?.slice()
    .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))[0];

let displayStatus = latestEstimation?.status ||req.status;

// üîë KEY FIX
if (
  latestEstimation?.approved === true &&
  latestEstimation?.status === "WAITING_FOR_APPROVAL"
) {
  displayStatus = "APPROVED";
}

              const statusColors = getStatusColors(displayStatus);
              const isPending = displayStatus === "PENDING";
              const isWaiting = displayStatus === "WAITING_FOR_APPROVAL";
              const hasEstimation = req.estimations && req.estimations.length > 0;
              
              return (
                <View key={req.requestId} style={styles.cardOuter}>
                  <View style={styles.cardInner}>
                    {/* Header Row */}
                    <View style={styles.headerRow}>
                      <View style={styles.titleContainer}>
                        <Text style={styles.title} numberOfLines={2}>
                          {req.itemName}
                        </Text>
                      </View>

                      <View
                        style={[
                          styles.statusBadge,
                          { backgroundColor: statusColors.bg },
                        ]}
                      >
                        <Text
                          style={[
                            styles.statusText,
                            { color: statusColors.text },
                          ]}
                        >
                          {formatStatus(displayStatus)}
                        </Text>
                      </View>
                    </View>

                    {/* Request ID */}
                    <View style={styles.idRow}>
                      <Text style={styles.idLabel}>ID:</Text>
                      <Text style={styles.idValue}>{req.requestId}</Text>
                    </View>

                    {/* Problem Description */}
                    <View style={styles.problemBox}>
                      <Text style={styles.problemLabel}>Problem</Text>
                      <Text style={styles.problemText}>
                        {req.problemDescription}
                      </Text>
                    </View>

                    {/* Contact Info */}
                    <View style={styles.contactRow}>
                      <View style={styles.contactIconContainer}>
                        <Text style={styles.contactIcon}>üìû</Text>
                      </View>
                      <Text style={styles.contactText}>{req.contactInfo}</Text>
                    </View>

                    {/* Divider */}
                    <View style={styles.divider} />

                    {/* Action Buttons */}
                    <View style={styles.buttonRow}>
                      {user.customer && (
                        <TouchableOpacity
                          style={styles.primaryButton}
                          onPress={() =>
                            navigation.navigate("UpdateStatus", {
                              requestId: req.requestId,
                            })
                          }
                          activeOpacity={0.8}
                        >
                          <Text style={styles.primaryText}>View Status</Text>
                        </TouchableOpacity>
                      )}

                      {user.admin && (
                        <>
                          <TouchableOpacity
                            style={styles.accentButton}
                            onPress={() =>
                              navigation.navigate("AddEstimation", {
                                requestId: req.requestId,
                              })
                            }
                            activeOpacity={0.8}
                          >
                            <Text style={styles.accentText}>Add Estimation</Text>
                          </TouchableOpacity>
                          </>
                      )}
                          {isWaiting && (
                            <>
                          <TouchableOpacity
                            style={styles.secondaryButton}
                            onPress={() =>
                              navigation.navigate("ApproveEstimation", {
                                requestId: req.requestId,
                              })
                            }
                            activeOpacity={0.8}
                          >
                            <Text style={styles.secondaryText}>
                              Approve Estimation
                            </Text>
                          </TouchableOpacity>
                        </>
                      )}
                      {hasEstimation && !isPending && !isWaiting &&(
                        <>
                        <TouchableOpacity
                            style={styles.secondaryButton}
                            onPress={() =>
                              navigation.navigate("ApproveEstimation", {
                                requestId: req.requestId,
                              })
                            }
                            activeOpacity={0.8}
                          >
                            <Text style={styles.secondaryText}>
                              View Estimation
                            </Text>
                          </TouchableOpacity>
                        </>
                      )}
                    </View>
                  </View>
                </View>
              );
            })}
          </View>
        ))}

        {/* Bottom Padding */}
        <View style={styles.bottomPadding} />
      </ScrollView>
    </LinearGradient>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
  },

  scrollView: {
    flex: 1,
  },

  contentContainer: {
    padding: 16,
  },

  loadingContainer: {
    flex: 1,
    justifyContent: "center",
    alignItems: "center",
  },

  loadingText: {
    marginTop: 16,
    fontSize: 14,
    color: COLORS.white,
    opacity: 0.9,
  },

  errorContainer: {
    flex: 1,
    justifyContent: "center",
    alignItems: "center",
    padding: 32,
  },

  errorText: {
    fontSize: 48,
    marginBottom: 16,
  },

  errorMessage: {
    fontSize: 16,
    color: COLORS.white,
    textAlign: "center",
    opacity: 0.9,
  },

  emptyContainer: {
    flex: 1,
    justifyContent: "center",
    alignItems: "center",
    padding: 32,
  },

  emptyIcon: {
    fontSize: 64,
    marginBottom: 16,
  },

  emptyTitle: {
    fontSize: 20,
    fontWeight: "700",
    color: COLORS.white,
    marginBottom: 8,
  },

  emptyMessage: {
    fontSize: 14,
    color: COLORS.white,
    textAlign: "center",
    lineHeight: 20,
    opacity: 0.9,
  },

  header: {
    marginBottom: 24,
    paddingHorizontal: 4,
  },

  headerTitle: {
    fontSize: 28,
    fontWeight: "700",
    color: COLORS.white,
    marginBottom: 4,
  },

  headerSubtitle: {
    fontSize: 14,
    color: COLORS.white,
    opacity: 0.8,
  },

  dateSection: {
    marginBottom: 32,
  },

  dateHeaderContainer: {
    flexDirection: "row",
    alignItems: "center",
    marginBottom: 16,
    paddingHorizontal: 4,
  },

  dateDivider: {
    flex: 1,
    height: 1,
    backgroundColor: "rgba(255, 255, 255, 0.3)",
  },

  dateHeader: {
    fontSize: 13,
    fontWeight: "600",
    color: COLORS.white,
    marginHorizontal: 12,
    textTransform: "uppercase",
    letterSpacing: 0.5,
    opacity: 0.9,
  },

  cardOuter: {
    marginBottom: 16,
  },

  cardInner: {
    backgroundColor: COLORS.cardBg,
    borderRadius: 22,
    padding: 20,
    borderWidth: 1,
    borderColor: COLORS.cardBorder,
    shadowColor: "#000",
    shadowOffset: {
      width: 0,
      height: 4,
    },
    shadowOpacity: 0.1,
    shadowRadius: 12,
    elevation: 5,
  },

  headerRow: {
    flexDirection: "row",
    justifyContent: "space-between",
    alignItems: "flex-start",
    marginBottom: 12,
  },

  titleContainer: {
    flex: 1,
    paddingRight: 12,
  },

  title: {
    fontSize: 18,
    fontWeight: "700",
    color: COLORS.textDark,
    lineHeight: 24,
  },

  statusBadge: {
    paddingVertical: 6,
    paddingHorizontal: 12,
    borderRadius: 20,
    alignSelf: "flex-start",
  },

  statusText: {
    fontSize: 11,
    fontWeight: "700",
    textTransform: "uppercase",
    letterSpacing: 0.5,
  },

  idRow: {
    flexDirection: "row",
    alignItems: "center",
    marginBottom: 14,
  },

  idLabel: {
    fontSize: 13,
    color: COLORS.textMuted,
    marginRight: 6,
  },

  idValue: {
    fontSize: 13,
    fontWeight: "600",
    color: COLORS.textDark,
    fontFamily: "monospace",
  },

  problemBox: {
    backgroundColor: COLORS.sectionBg,
    borderRadius: 14,
    padding: 14,
    marginBottom: 12,
  },

  problemLabel: {
    fontSize: 11,
    fontWeight: "600",
    color: COLORS.textMuted,
    textTransform: "uppercase",
    letterSpacing: 0.5,
    marginBottom: 6,
  },

  problemText: {
    fontSize: 14,
    color: COLORS.textDark,
    lineHeight: 20,
  },

  contactRow: {
    flexDirection: "row",
    alignItems: "center",
    backgroundColor: COLORS.sectionBg,
    borderRadius: 14,
    padding: 12,
    marginBottom: 4,
  },

  contactIconContainer: {
    width: 32,
    height: 32,
    borderRadius: 16,
    backgroundColor: COLORS.white,
    justifyContent: "center",
    alignItems: "center",
    marginRight: 10,
  },

  contactIcon: {
    fontSize: 16,
  },

  contactText: {
    fontSize: 14,
    fontWeight: "600",
    color: COLORS.textDark,
    flex: 1,
  },

  divider: {
    height: 1,
    backgroundColor: COLORS.cardBorder,
    marginVertical: 16,
  },

  buttonRow: {
    flexDirection: "row",
    flexWrap: "wrap",
    gap: 10,
  },

  primaryButton: {
    backgroundColor: COLORS.primary,
    paddingVertical: 14,
    paddingHorizontal: 20,
    borderRadius: 16,
    flex: 1,
    minWidth: "100%",
    alignItems: "center",
    shadowColor: COLORS.primary,
    shadowOffset: {
      width: 0,
      height: 4,
    },
    shadowOpacity: 0.3,
    shadowRadius: 8,
    elevation: 4,
  },

  primaryText: {
    color: COLORS.white,
    fontWeight: "700",
    fontSize: 15,
    textAlign: "center",
  },

  accentButton: {
    backgroundColor: COLORS.accent,
    paddingVertical: 14,
    paddingHorizontal: 20,
    borderRadius: 16,
    flex: 1,
    minWidth: "48%",
    alignItems: "center",
    shadowColor: COLORS.accent,
    shadowOffset: {
      width: 0,
      height: 2,
    },
    shadowOpacity: 0.2,
    shadowRadius: 6,
    elevation: 3,
  },

  accentText: {
    color: COLORS.textDark,
    fontWeight: "700",
    fontSize: 14,
    textAlign: "center",
  },

  secondaryButton: {
    backgroundColor: COLORS.white,
    paddingVertical: 14,
    paddingHorizontal: 20,
    borderRadius: 16,
    flex: 1,
    minWidth: "48%",
    alignItems: "center",
    borderWidth: 2,
    borderColor: COLORS.primary,
  },

  secondaryText: {
    color: COLORS.primary,
    fontWeight: "700",
    fontSize: 14,
    textAlign: "center",
  },

  bottomPadding: {
    height: 20,
  },
      backButton: {
    width: 48,
    height: 48,
    borderRadius: 30,
    backgroundColor: 'rgba(255, 255, 255, 0.2)',
    justifyContent: 'center',
    alignItems: 'center',
    marginBottom: 5,
  },
});
