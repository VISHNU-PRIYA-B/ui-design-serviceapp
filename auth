import { graphqlRequest, setAuthToken} from "./api";
import AsyncStorage from "@react-native-async-storage/async-storage";

export { setAuthToken };

export const fetchCurrentUser = async(token?:string) =>{

    const query = `
    query{
    currentUser{
    id
    email
    
    companyName
    name
    profilePic
    customer
    admin
    }
    }
    `;
    try{
        const data = await graphqlRequest(query,{},token);
        return data?.currentUser || null;
     }
     catch(error){
        console.error("Error fetching user",error);
        return null;
     }
};

// Signup
export const signupUser = async (email: string, password: string, name: string, companyName:string) => {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

  if (!emailRegex.test(email)) {
    return {
      success: false,
      message: "Invalid email format. Example: name@gmail.com",
    };
  }
  const SIGNUP_MUTATION = `
    mutation CreateUser($email: String!, $password: String!, $name: String!,$companyName:String!) {
      createUser(email: $email, password: $password, name: $name,companyName:$companyName) {
        user { id email name companyName}
        token
        success
        message
      }
    }
  `;
  try {
    const data = await graphqlRequest(SIGNUP_MUTATION, { email, password, name,companyName });
    const result = data?.createUser;
    if (result?.success) return { success: true, token: result.token, user: result.user };
    return { success: false, message: result?.message || "Signup failed" };
  } catch (error) {
    console.error("Signup error:", error);
    return { success: false, message: "Something went wrong" };
  }
};

// Login
export const loginUser = async (email: string, password: string) => {
  const LOGIN_MUTATION = `
    mutation CustomTokenAuth($email: String!, $password: String!) {
      customTokenAuth(email: $email, password: $password) {
        success
        message
        token
        user {
          id
          email
          customer
          admin
        }
      }
    }
  `;

  try {
    const data = await graphqlRequest(LOGIN_MUTATION, { email, password });
    const result = data?.customTokenAuth;

    if (!result?.success) {
      throw new Error(result?.message);
    }

    setAuthToken(result.token);
    await AsyncStorage.setItem("token", result.token);

    return { token: result.token, user: result.user };
  } catch (error: any) {
    
    throw new Error(error.message || "Something went wrong");
  }
};


